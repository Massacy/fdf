NAME = cub3D
CC = cc
CFLAGS = -Wall -Werror -Wextra -MMD -MP -O2
SRCDIR = src
OBJDIR = obj
SRC = ## 省略

OBJ = $(SRC:$(SRCDIR)/%.c=$(OBJDIR)/%.o)

LIBFTDIR = ./lib/libft
LIBFT_A = $(LIBFTDIR)/libft.a

MINILIBXDIR = ./lib/minilibx
MINILIBX = libmlx.dylib

MAPS = $(shell find map/normal/ -type f)
TEST_MAPS = $(shell find map/error/ -type f)

INCLUDE = -I ./include/ -I $(LIBFTDIR)/incs/ -I $(MINILIBXDIR)/

DEPS := ${addprefix ${OBJDIR}/, ${SRC:.c=.d}}
-include ${DEPS}

#: Make executable file.
all: $(OBJDIR) $(NAME)

$(NAME): $(OBJ) $(LIBFT_A) $(MINILIBX)
    $(CC) $(OBJ) $(LIBFT_A) $(MINILIBX) -o $(NAME)

$(OBJDIR):
    mkdir $(shell find $(SRCDIR) -type d | sed 's/^$(SRCDIR)/$(OBJDIR)/g')

$(OBJDIR)/%.o: $(SRCDIR)/%.c
    $(CC) $(CFLAGS) $(INCLUDE) -o $@ -c $<

$(LIBFT_A):
    $(MAKE) -C $(LIBFTDIR)

$(MINILIBX):
    $(MAKE) -C $(MINILIBXDIR)
    cp $(MINILIBXDIR)/$(MINILIBX) ./

#: Remove all object files.
clean:
    $(RM) -rf $(OBJDIR)
    $(RM) $(MINILIBX)
    $(MAKE) fclean -C $(LIBFTDIR)
    $(MAKE) clean -C $(MINILIBXDIR)

#: Remove all object and executable files.
fclean: clean
    $(RM) $(NAME)

#: Remove and recompile all.
re: fclean all

#: Open error maps.
t: all
    @for map in ${TEST_MAPS} ; \
    do echo $$map ; ./${NAME} $$map ; echo "$?"; done

#: Open normal maps.
p: all
    @for map in ${MAPS} ; \
    do echo $$map ; ./${NAME} $$map ; echo "$?"; done

#: Check norminette.
norm:
    @${PRINTF} "${RED}\nChecking norm for ${NAME}...${DEFAULT}\n "
    @norminette ${SRCDIR} include/ lib/libft

# Check approved functions.
nm: $(NAME)
    @nm -u $(NAME) | grep -v -e 'mlx_' -e 'ft_' -e ' __' -e ' X'

#: Display all commands.
help:
    @grep -A1 -E "^#:" Makefile \
    | grep -v -- -- \
    | sed 'N;s/\n/###/' \
    | sed -n 's/^#: \(.*\)###\(.*\):.*/\2###\1/p' \
    | sed -e 's/^/make /' \
    | column -t -s '###'

.PHONY : all clean fclean re t p norm nm help